# 数据库事务
事务是一个不可分割的数据库操作序列，也是数据库并发控制的基本单位，其执行结果必须使数据库从一种一致性状态到另一种一致性状态。

## 事务的特征
* 原子性：事务包含的一系列数据库操作要么全做，要么全不做，或者说要么全部执行，要么全部回滚。

* 一致性：事务的执行结果必须是数据库从一个一致性状态到另一个一致性状态。因此数据库中只包含成功事务提交的结果时，就说数据库处于一个一致性状态；如果数据库系统运行过程中出现错误，有些事务尚未完成就发生中断，这些未完成的事务对数据库的修改有一部分已经写入数据库，这时数据库就处于一种不一致的状态。
* 隔离性：并发执行的事务之间不能相互影响。
* 持久性：事务一旦提交，对数据库的修改是永久性的。


# 事务的并发执行
在多处理机中，每个处理机可以运行一个事务，多个处理机同时可以运行多个事务，实现多个事务的并行运行。这种并行执行方式称为并发执行。事务是并发执行的基本单位。

## 并发执行带来的问题
多个用户并发的存取数据库时，就会产生多个事务同时存取同一数据的情况。若对并发操作不加控制就可能会存储和存取不正确的数据，破坏事务的一致性和数据库的一致性。并发操作带来的数据不一致性有以下几种：
* 脏读：一个事务**读取到另一个事务中未提交的数据**，另一个事务中数据可能进行了改变，此时读取到的数据可能和数据库中是不一致的，该数据即为脏数据，读取脏数据的过程叫脏读。
* 幻读：针对两次读取的情况，结果不一致，主要针对的操作是新增或者删除。事务A按照特定条件查询出结果，事务B新增了一条符合条件的数据，事务A再次读取，两次读取的结果不一致。
* 不可重复读：两次读取，主要针对的是修改操作。事务A第一次**读取事务后，事务B对A读取的数据进行修改**，事务A再次读取，两次读取的数据不一致，称为不可重复读。
* 丢失修改：**一个事务的更新覆盖了另一个事务的更新**。（封锁中添加了丢失修改的问题，隔离级别中并没有提到丢失修改的问题）。

## 隔离级别
隔离级别决定了一个session的事务中可能对另一个session中事务的影响。ANSI标准定义了4个隔离级别，MySQL的InnoDB都支持，分别是：
* READ UNCOMMITTED：最低级别的隔离，通常又称为dirty read，它允许一个事务读取另一个事务还没commit的数据。
    * 可以提高性能。
    * 可能导致脏读、幻读、不可重复读的问题。
* READ COMMITTED：只能读取其他事务中已经提交的数据。
    * 可以防止脏读，不能避免不可重复读和幻读的问题。
* REPEATABLE READ：读取的数据添加上锁，防止其他事务修改这些数据。但是其他事务可以对数据库进行添加或删除操作。
    * 可以防止脏读和不可重复读，但是不能避免幻读问题。
* SERIALIZABLE：最高级别的隔离，只允许事务串行执行。
    * 可以避免所有的安全问题。
    * 效率低下。

MySQL默认的隔离级别是REPEATABLE READ。

## MySQL的事务支持
MySQL的事务支持不是绑定在MySQL服务器本身，而是和存储引擎相关：
* MyISAM：不支持事务，只用于读取程序提高性能。
* InnoDB：支持ACID事务、行级锁、并发。
* Berkeley DB：支持事务。

## 并发控制机制
并发控制机制就是要用正确的方式调度并发操作，是一个用户事务的执行不受其他事务的干扰，从而避免数据的不一致性。
### 封锁
封锁就是事务在对某个数据对象操作之前，先向系统发出请求，对其加锁，在事务释放锁之前，其他事务不能对数据进行操作。
* 排他锁：又称为写锁、X锁，若事务对数据对象加上X锁，那么只允许该事务读取和修改数据，其他事务不能再对数据对象加锁。直到事务释放锁为止。
* 共享锁：又称为读锁、S锁，若事务对数据对象加上S锁，则该事务可以读取但是不能修改，其他事务只能再对数据加S锁，不能加X锁。
### 封锁协议
使用S和X这两种基本锁对数据对象加锁时，还需要约定一些规则，例如何时申请X锁或S锁、封锁时间、合适释放等，这些规则称为封锁协议：
* 一级封锁协议（对应READ UNCOMMITED）：事务在修改数据之前先对其加X锁，直到事务结束才释放，事务结束包括正常结束COMMIT和非正常结束ROLLBACK。
    * 防止丢失修改
    * 不能避免脏读、幻读、不可重复读。
* 二级封锁协议（对应READ COMMITED）：在一级封锁协议的基础上加上事务在读取数据之前先对其加上S锁，读完后释放S锁。
    * 不能避免幻读、不可重复读。
* 三级封锁协议（对应REAPETABLE READ）：在一级封锁协议的基础上增加了在事务读取数据之前必须先对其加S锁，直到事务结束才释放。
    * 不能避免幻读。
### 封锁和隔离级别的关系
隔离级别可以理解为锁的一个整体打包方案，其中封装了各种锁。一般来说实际开发中使用各种锁的几率比较小，更多的是使用数据库提供的四个隔离级别。