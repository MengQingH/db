# 数据库索引
索引是对数据库表中**对一个或多个列进行排序的数据结构**，以协助快速查找、更新数据库表中的数据。索引的实现通常是B-Tree及其变种。索引增加了数据访问，因此存储引擎不会再去扫描整张表得到需要的数据；相反，它从根节点开始，根节点保存了子节点的指针，存储索引会根据指针快速寻找数据。
<br><img src=img/数据库索引.png><br>
上图中右边的索引是包含col2列的键值和对应数据的指针，这样就可以通过B-Tree再O(logn)时间复杂度内获取相应的数据。

## 索引的类型：
* B-Tree索引：基于B-Tree数据结构。B-Tree的基本思想是，所有值（被索引的列）都是**排过序**的，每个叶节点到跟节点距离相等。所以B-Tree适合**用来查找某一范围内的数据**，而且可以**直接支持数据排序**（ORDER BY）。InnoDB和MyISAM都支持B-Tree索引。InnoDB用的是一个变种B+Tree，而MyISAM为了节省空间对索引进行了压缩，从而牺牲了性能。
* Hash索引：基于hash表。所以这种索引**只支持精确查找，不支持范围查找，不支持排序**。这意味着范围查找或ORDER BY都要依赖server层的额外工作。目前只有Memory引擎支持显式的hash索引（但是它的hash是nonunique的，冲突太多时也会影响查找性能）。Memory引擎默认的索引类型即是Hash索引，虽然它也支持B-Tree索引。

## 索引sql
### **创建索引**
```sql
create [unique][clustered | nonclustered]  index  index_name  
on {table_name | view_name} [with [index_property [,....n]]
```
说明：
* unique：唯一索引。
* clustered：聚簇索引
* nonclustered：非聚簇索引
* index_property：索引属性
* unique唯一索引既可以采用聚簇索引，也可以采用非聚簇索引。
### 删除索引
```sql
drop index table_name.index_name[,table_name.index_name]
```


## 索引的优点
创建索引可以大大提高系统的性能：
1. 使用创建唯一索引，可以保证数据库表中每一行数据的唯一性。
2. 可以大大**加快数据的检索速度**，这也是创建索引的最主要的原因。
3. 可以**加速表和表之间的连接**，特别是在实现数据的参考完整性方面特别有意义。
4. 在使用分组和排序子句进行数据检索时，同样可以显著**减少查询中分组和排序的时间**。
5. 通过使用索引，可以在查询的过程中，使用优化隐藏器，提高系统的性能。 

## 索引的缺点
* 创建索引和维护索引要消耗时间
* 当对表中的数据进行增加、删除和修改的时候，索引也要动态的为维护，这样就降低了数据的维护速度。
* 索引需要物理空间。

## 适合创建索引的字段
索引是创建在数据库的某些列上面。在创建索引的时候，一般在下面的列上创建索引：
* **经常需要搜索的列**上，可以加快搜索速度

* **作为主键的列**上，强制该列的唯一性和组织表中数据的排列结构
* **经常作表连接的列**上，这些列主要是一些外键，可以加快连接的速度。
* **经常需要根据范围搜索的列**上，因为所以已经排序，其指定的范围是连续的。
* **经常需要排序的列**上创建索引，因为索引已经排序，这样查询可以利用索引的排序，加快排序查询时间。
* **经常用在where中的列**上创建索引，可以加快条件判断时间。

## 覆盖索引
如果一个索引包含了所有需要查询的字段的值，而不必从数据库中获取，称为覆盖索引，即只需要扫描索引，无需返回表。

当一条查询语句符合覆盖索引条件时，sql只需要通过索引就可以返回查询所需要的数据，这样避免了查到索引后再返回表操作，减少了IO提高效率。

满足下列条件不会执行覆盖查询：
1. select选择的语句含有不在索引中的字段。
2. where条件中含有like操作

## 联合索引
同时建立在多个列上的索引叫做联合索引，也叫多列索引。加入在列a b c上建立了多列索引，实际上索引是先对a进行排序，然后在排序的基础上再对b进行排序，再按同样的方式对c排序，可以理解为建立的索引是(a) (a, b) (a, b, c)。所以如果索引中的列是b和c的话，那么无法使用索引。多列索引的优点：
* 减少开销：创建一个列为a b c的联合索引，那么实际上相当于创建了(a) (a, b) (a, b, c)三个索引。
* 覆盖索引：如果一个sql中的使用的列全在索引中，那么MySQL可以直接通过遍历索引获得数据，而不需要返回表，这减少了很多io操作。
* 效率高：索引列越多，通过索引筛选出的列越少。


## 最左匹配原则
意思是左边的优先，多列索引中以左边的列为起点的任何连续索引都能匹配上。

## 唯一索引
唯一索引是**不允许其中任何两行具有相同索引值的索引**，可以为空。主键可以用作创建唯一索引的列，但是唯一索引不一定是主键，也可以是其他不能相同的列。
* 普通唯一索引：单个字段上建立唯一索引，需要此字段上不能有重复的值，属于二级索引。
* 复合唯一索引：多个字段上联合建立唯一索引，属于耳机索引。

## 主键 自增主键 主键索引 唯一索引
* 主键：指字段唯一、不为空值的列。
* 自增主键：字段类型为数字，自增，并且是主键。
* 主键索引：指的就是主键，主键是索引的一种，是唯一索引的特殊类型。创建主键的时候，数据库会默认为主键创建一个唯一索引。
* 唯一索引：索引列的值必须唯一，但**允许有空值**。


## 聚簇索引和非聚簇索引
聚簇索引的叶子节点就是数据行，非聚簇索引的叶子节点只是索引，只不过有指向对应数据块的指针。
<img src=img/clustered.jpg>

### **聚簇索引**
聚簇索引并不是一种单独的索引类型，而是一种数据存储方式，比如InnoDB的聚簇索引使用B+Tree的数据结构存储数据。聚簇索引是**对实际数据**重新组织以**按指定的一个或多个列的值排序**的存储方式，特点是存储数据的顺序和索引顺序一致。一般情况下**主键**会默认创建一个聚簇索引，由于聚簇索引中存放着表的数据，所以一张表**只能存在一个**聚簇索引。
1. InnoDB通常根据主键创建一个聚簇索引
2. 如果没有主键，则会用一个唯一且不为空的索引列做为主键，称为此表的聚簇索引
3. 如果两个条件都不满足，那么InnoDB会自己创建一个虚拟的聚簇索引。

二级索引：在聚簇索引之上建立的索引叫做二级索引/辅助索引(Secondary kay)，辅助索引叶子节点存储的不再是行的物理位置，而是**主键值**。通过辅助索引首先找到的是主键值，再通过主键值找到数据。

聚簇索引的优点：
1. 数据访问更快，聚簇索引将索引和数据保存在一个B+Tree中，因此从聚簇索引中获取数据比非聚簇索引中快得多。

缺点：
1. 插入速度严重依赖插入顺序。
2. 更新聚簇索引列的代价很高，会移动很多行。
3. 基于聚簇索引的表插入新行，或者主键被更新导致需要移动行的时候，可能面临“页分裂”的风险。当行的主键值要求必须将这一行插入到某个已满的页中时，存储引擎会将该页分裂成两个页面来容纳该行，这就是一次分裂操作。页分裂会导致表占用更多的磁盘空间。
### **非聚簇索引**
非聚簇索引的索引和数据是分开存储的，通过索引访问数据时，先查找索引，再通过索引找到磁盘对应数据。


## B+Tree
B+树是为磁盘或其他直接存取辅助设备而设计的一种平衡查找树，在B+树中，所有记录结点都是按键值的大小顺序存放在同一层的叶节点中，各叶节点进行连接。

## 使用B-Tree的原因
一般来说，索引本身很大，不可能全部存储到内存中，因此索引往往存储在磁盘中，这样的话，索引查找过程中就要产生磁盘I/O消耗，相对于内存存取，I/O存取的消耗要高上好几个数量级，所以一个数据结构作为索引的优劣最重要的指标就是在查找过程磁盘I/O操作次数的复杂度。换句话说，索引的结构组织要尽量减少查找过程中磁盘I/O的存取次数。为什么使用B树，还和磁盘存取原理有关。
### 局部性原理和磁盘预读
由于存储介质的特性，磁盘存取比主存慢得多。因此为了提高效率，要尽可能减少I/O次数，为了达到这个目的，磁盘往往不是严格按需读取，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存，这样做的原理是计算机科学中的局部性原理：当一个数据被使用时，其附近的数据也通常会马上被使用。

由于磁盘顺序读取的效率很高，因此对于具有局部性的程序来说，预读可以提高I/O效率。数据库系统利用了磁盘预读原理，将一个节点的大小设置为一个页，这样每个节点只需要一次I/O就可以完全载入。

### 为什么B+树比B树更适合实际应用中的操作系统的文件索引和数据库索引？
* B+树的磁盘读写代价更低：B+tree的内部结点并没有指向关键字具体信息的指针(红色部分)，因此其内部结点相对B树更小。
* B+Tree的查询效率更加稳定：由于内部结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引，所以，任何关键字的查找必须走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当；
* **B+树只要遍历叶子节点就可以实现整棵树的遍历，而且在数据库中基于范围的查询是非常频繁的，而B树只能中序遍历所有节点，效率太低。**（主要原因）


## InnoDB和MyISAM索引结构上的区别
* MyISAM索引文件和数据文件是分离的，索引文件仅保存**数据记录的地址**，通过索引可以直接获取到数据记录，而不需要像InnoDB索引再遍历一遍主键索引。
* InnoDB中，表数据文件本身就是按照B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录。这个索引的key是数据表的主键。
* InnoDB的辅助索引中data域存放的是主键的值而不是地址